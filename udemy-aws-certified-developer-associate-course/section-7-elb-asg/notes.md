# ELB + ASG

## High Availability & Scalability

- Scalability => an application / system can handle greater loads by adapting
- Two types of scalability:
  - Vertical scalability
  - Horizontal scalability (elasticity)
- Scalability is liked but different to High Availability

### Vertical Scalability

- Vertically scalability means **increasing the size of the instance**
- going from a t2.micro -> t2.large
- common for non-distributed systems
- RDS, ElastiCache are services that can scale vertically

### Horizontal Scalability

- Horizontal scalability means **increasing the number of instances**
- Horizontal scaling implies distributed systems
- Common for web apps / modern apps

### High Availability

- Means running application in at least 2 data centers (AKA AZs)
- Goal is to survive data center loss

#### High availability & scalability for EC2

- Vertical scaling: Increase instance size (scale up / down)
- Horizontal scaling: Increase number of instances (scale out / in)
- High availability: run instances for the same app in multi AZ
  - Auto scaling group multi AZ
  - Load balancer multi AZ

## Load balancer

- Servers that forward traffic to multiple services (e.g. EC2 instances) downstream
- Spread the load across multiple downstream instances
- Expose a single point of access to the app
- Handle failures of downstream instances
- Do healh checks on instances
- Provide SSL termination for websites
- Enforce stickiness with cookies
- High availability across AZ
- Separate public traffic from private traffic

### Elastic Load Balancer

- Managed load balancer from AWS
- Integrated with many AWS services
  - EC2, EC2 Auto scaling Groups, ECS
  - AWS Certificate Manager (ACM), CloudWatch
  - Route 53, AWS WAF, AWS Global Accelerator

### Health Checks

- Enable load balancer to know if instances it forwards traffic to are available to handle requests
- Health check is done on a port and a route (`/health` is common)
- If the response in not 200, traffic will not be routed to that instance

### Types of load balancer on AWS

- 4 types of managed Load Balancers:
  - Classic Load Balancer (v1 - old generation) - CLB
    - HTTP, HTTPS, TCP, SSL (Secure TCP)
  - Application Load Balancer - ALB
    - HTTP, HTTPS, Websocket
  - Network Load Balancer - NLB
    - TCP, TLS (Secure TCP), UDP
  - Gateway Load Balancer - GWLB
    - Operates at Layer 3 - IP protocol
- Some load balancers can be setup as internal (private) or external (public) ELBs

### Load Balancer Security Groups

- Load balancer security group
  - Specific type, protocol, port etc with source = `0.0.0.0/0` (anywhere)
- Then have a security group on the application which only accepts requests from the load balancer
  - Enhanced security mechanism

#### Application Load Balancer

- Layer 7 only (HTTP)
- Route to multiple HTTP applications across machines (target groups)
- Load balance to multiple applications on the same machine (ex containers)
- Support for HTTP/2 and Websockets
- Support redirects
- Support routing tables
  - Routing based on path in URL e.g. /user and /search can sit behind the same ALB
  - Routing based on hostname in URL
  - Routing based on Query String, Headers
- ALB great for microservices and container-based application
- Port mapping feature to redirect to a dynamic port in ECS

#### ALB Target Groups

- Can be EC2 instances
- Can be ECS tasks
- Can be Lambda functions
- Can be IP addresses (must be private IPs)
- ALB can route to multiple target groups
- Health checks are at the target group level

#### Network Load Balancer

- Layer 4 load balancer
- Forward TCP & UDP traffic
- Less latency (~100ms vs 400ms for ALB)
- one static IP per AZ
- used for extreme performance, TCP or UDP traffic
- not included in free tier

#### NLB Target Groups

- Can be EC2 instances
- Can be IP addresses (must be private IPs)
- Can be ALB
- Health checks support TCP, HTTP and HTTPS

#### Gateway Load Balancer

- Operates at Layer 3 (Network layer) - IP Packets
- Transparent network gateway
  - single entry/exit for all traffic
- Load Balancer
  - distributes traffic to your virtual applicances
- Uses the GENEVE protocol on port 6081
- Example use-cases:
  - Firewalls
  - Intrusion detection and prevention systems
  - Deep packet inspection systems
  - Payload manipulation

#### GLB Target Groups

- EC2 instances
- IP Addresses

## Sticky Sessions (Session affinity)

- Same client is always redirected to the same instance behind a load balancer
- Available for ALB and NLB
- A cookie is used that has an expiration date
- Make sure user doesn't lose their session data
- Can bring imbalance to the load

### Cookie names

- Application-based Cookies
  - Custom cookie
    - Generated by the target
    - Can include any custom attributes required
    - Cookie name must be specified individually for each target group
    - Some reserved words for AWS services
  - Duration-based cookie
    - Cookie generated by the load balancer
    - Cookie name is AWSALB for ALB, AWSELB for CLB

## Cross-Zone Load Balancing

- distributes incoming traffic across ALL instances in ALL AZs
- ALB
  - enabled by default
  - no charges for inter-AZ data
- NLB / GLB
  - disabled by default
  - pay charges for inter-AZ data if enabled

## SSL / TLS Certificates

- Allows traffic between client and load balancer to be encrypted in transit (in-flight encryption)
- SSL = Secure Sockets Layer
- TLS = Transport Layer Security (newer version)
- Public SSL certs are issued by Certificate Authorities (CA)
- SSL certs have expiration date and must be renewed regularly
- Load balancer uses an X.509 cert
- Can manage certs using ACM (AWS Certificate Manager)
- Can upload your own certificates
- HTTPS listener:
  - must specify a default certificate
  - Add an optional list of certs to support multiple domains
  - Clients can use SNI (Server Name Indication) to specify the hostname they reach

### Server Name Indication (SNI)

- SNI solves the problem of loading multiple SSL certs onto one web server (to serve multiple websites)
- Requires the client to indicate the hostname of the target server in the initial SSL handshake
- Server will then find the correct cert or return the default one
- Only works for ALB, NLB, Cloudfront

## Connection Draining

- Deregistration Delay (ALB and NLB)
- Connection Draining (CLB)
- Gives time to complete in-flight requests while the instance is de-registering or unhealthy
- Stops sending new requests to the EC2 instance which is de-registering
- Between 1 to 3600 seconds (default: 300 seconds)
- Can be disabled (set value to 0)
- Set to a low value if your requests are short 

## Auto Scaling Group (ASG)

- Scale out (add EC2 instances) to match an increased load
- Scale in (remove EC2 instances) to match a decreased load
- Ensure we have a min and max number of EC2 instances

### Auto Scaling Group Attributes

- A Launch Template
  - AMI + Instance Type
  - EC2 User Data
  - EBS Volumes
  - Security Groups
  - SSH Key Pair
  - IAM Roles for your EC2 instances
  - Network + Subnets information
  - Load Balancer Information
- Min / Max / Initial Capacity
- Scaling policies

### CloudWatch Alarms and Scaling

- Scale an ASG in/out based on CloudWatch alarms
- Alarm monitors a metric (such as Average CPU or a custom metric)
- Auto scaling event is triggered by alarm

